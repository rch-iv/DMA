<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMA Memory Hashing & Verification Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s ease-in-out;
            color: #6b7280;
        }
        .file-upload-label:hover {
            border-color: #9ca3af;
        }
        .correct-hash-icon { color: #10B981; }
        .incorrect-hash-icon { color: #EF4444; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl p-8 max-w-3xl w-full">
        <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">DMA Memory Hashing & Verification Tool</h1>
        <p class="text-gray-500 mb-6 text-center">Paste or upload a memory JSON file to hash or verify it.</p>

        <div class="space-y-4">
            <!-- Paste Input Area -->
            <div>
                <label for="jsonInput" class="block text-gray-700 text-sm font-semibold mb-2">Paste JSON Here</label>
                <textarea id="jsonInput" rows="10" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm" placeholder='Paste your memory JSON object here, e.g., {"summary": "My first memory...", "content": "..."}'></textarea>
            </div>

            <div class="relative flex items-center py-2">
                <div class="flex-grow border-t border-gray-300"></div>
                <span class="flex-shrink mx-4 text-gray-400">OR</span>
                <div class="flex-grow border-t border-gray-300"></div>
            </div>

            <!-- Upload Button Area -->
            <div>
                <label for="fileUpload" class="file-upload-label">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    <span id="fileLabel">Upload a JSON File</span>
                </label>
                <input type="file" id="fileUpload" name="fileUpload" class="hidden" accept="application/json">
            </div>

            <div class="flex space-x-4">
                <button id="processButton" class="w-1/2 bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105 shadow-md disabled:bg-gray-400 disabled:transform-none disabled:cursor-not-allowed">
                    Generate New Hash
                </button>
                <button id="verifyButton" class="w-1/2 bg-green-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-700 transition duration-300 transform hover:scale-105 shadow-md disabled:bg-gray-400 disabled:transform-none disabled:cursor-not-allowed">
                    Verify Existing Hash
                </button>
            </div>
        </div>

        <div id="status" class="text-sm text-center font-medium min-h-6 mt-4"></div>

        <div id="jsonContainer" class="bg-gray-800 text-gray-200 rounded-lg p-4 mt-6 overflow-x-auto hidden">
            <pre><code id="jsonOutput"></code></pre>
        </div>

    </div>

    <script>
        // Use a self-invoking async function to run the logic after the DOM is ready
        (async function() {
            const jsonInput = document.getElementById('jsonInput');
            const fileUpload = document.getElementById('fileUpload');
            const fileLabel = document.getElementById('fileLabel');
            const processButton = document.getElementById('processButton');
            const verifyButton = document.getElementById('verifyButton');
            const statusDiv = document.getElementById('status');
            const jsonContainer = document.getElementById('jsonContainer');
            const jsonOutput = document.getElementById('jsonOutput');

            // Hashing function using the browser's native Web Crypto API
            async function sha256(str) {
                const textAsBuffer = new TextEncoder().encode(str);
                const hashBuffer = await crypto.subtle.digest('SHA-256', textAsBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                return hashHex;
            }

            // Function to handle the JSON processing (common logic for both buttons)
            async function processJson(jsonString, mode) {
                try {
                    statusDiv.innerHTML = `<span class="text-gray-500">Processing...</span>`;
                    processButton.disabled = true;
                    verifyButton.disabled = true;

                    const memoryObject = JSON.parse(jsonString);
                    const hashableObject = { ...memoryObject };
                    const originalHash = memoryObject?.verification?.hash;
                    
                    if (hashableObject.hasOwnProperty('verification')) {
                        delete hashableObject.verification;
                    }
                    
                    const hashableString = JSON.stringify(hashableObject, Object.keys(hashableObject).sort());
                    const computedHash = await sha256(hashableString);

                    let finalMemory = memoryObject;
                    let message = '';

                    if (mode === 'generate') {
                        finalMemory = {
                            ...memoryObject,
                            "verification": {
                                "hash": computedHash,
                                "signed_by": "AI",
                                "signature_type": "soulchain-v1",
                                "schema_version": "memory-1.4"
                            }
                        };
                        message = "Success! New hash generated and added to the memory artifact.";
                        
                        const jsonFormatted = JSON.stringify(finalMemory, null, 2);
                        const blob = new Blob([jsonFormatted], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `hashed_memory_${Date.now()}.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                        jsonOutput.textContent = jsonFormatted;
                        jsonContainer.classList.remove('hidden');

                    } else if (mode === 'verify') {
                        if (!originalHash) {
                            message = `<span class="text-red-500 font-bold">Error: No existing hash found in the memory artifact to verify against.</span>`;
                        } else if (computedHash === originalHash) {
                            message = `<span class="text-green-600 font-bold">Verification Successful!</span> <span class="correct-hash-icon">✅</span> The hash matches the memory contents.`;
                        } else {
                            message = `<span class="text-red-500 font-bold">Verification Failed!</span> <span class="incorrect-hash-icon">❌</span> The hash does NOT match the memory contents. This memory may have been tampered with.`;
                        }
                        jsonOutput.textContent = JSON.stringify(memoryObject, null, 2);
                        jsonContainer.classList.remove('hidden');
                    }
                    
                    statusDiv.innerHTML = message;

                } catch (error) {
                    statusDiv.innerHTML = `<span class="text-red-500 font-bold">Error: Invalid JSON. Please check your input.</span>`;
                    console.error("JSON processing error:", error);
                } finally {
                    processButton.disabled = false;
                    verifyButton.disabled = false;
                }
            }

            // Event listener for the process button
            processButton.addEventListener('click', () => {
                const input = jsonInput.value.trim();
                const file = fileUpload.files[0];
                if (input !== '') {
                    processJson(input, 'generate');
                } else if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => processJson(e.target.result, 'generate');
                    reader.readAsText(file);
                } else {
                    statusDiv.innerHTML = `<span class="text-gray-500">Please paste JSON or upload a file.</span>`;
                }
            });

            // Event listener for the verify button
            verifyButton.addEventListener('click', () => {
                const input = jsonInput.value.trim();
                const file = fileUpload.files[0];
                if (input !== '') {
                    processJson(input, 'verify');
                } else if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => processJson(e.target.result, 'verify');
                    reader.readAsText(file);
                } else {
                    statusDiv.innerHTML = `<span class="text-gray-500">Please paste JSON or upload a file.</span>`;
                }
            });

            // Update file label text when a file is selected
            fileUpload.addEventListener('change', () => {
                if (fileUpload.files.length > 0) {
                    fileLabel.textContent = fileUpload.files[0].name;
                    jsonInput.value = '';
                } else {
                    fileLabel.textContent = "Upload a JSON File";
                }
            });

            // Clear file upload if user starts typing in the text area
            jsonInput.addEventListener('input', () => {
                if (jsonInput.value.trim() !== '') {
                    fileUpload.value = '';
                    fileLabel.textContent = "Upload a JSON File";
                }
            });

            statusDiv.innerHTML = `<span class="text-gray-500">Waiting for input...</span>`;
        })();
    </script>
</body>
</html>
